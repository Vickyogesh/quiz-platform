#!/bin/bash
# This deploy hook gets executed after dependencies are resolved and the
# build hook has been run but before the application has been started back
# up again.  This script gets executed directly, so it could be python, php,
# ruby, etc.

echo "Pre-processing nginx config..."
env | sed 's/[\%]/\\&/g;s/\([^=]*\)=\(.*\)/s%${\1}%\2%/' > $OPENSHIFT_TMP_DIR/sed.script
cat $OPENSHIFT_REPO_DIR/misc/nginx.conf | sed -f $OPENSHIFT_TMP_DIR/sed.script > $OPENSHIFT_DATA_DIR/nginx/conf/nginx.conf

if [ ! -d $OPENSHIFT_DATA_DIR/quiz/img ]; then
echo "Unpacking images..."
unzip -o $OPENSHIFT_REPO_DIR/misc/img.zip -d $OPENSHIFT_DATA_DIR/quiz/img
fi

# Generate documantation (if needed).
if [ -d $OPENSHIFT_DATA_DIR/quiz/apidoc ]; then
$OPENSHIFT_DATA_DIR/bin/sphinx-build -b html  $OPENSHIFT_REPO_DIR/doc $OPENSHIFT_DATA_DIR/quiz/apidoc
fi

# Generate translations
source $OPENSHIFT_DATA_DIR/venv/bin/activate
$OPENSHIFT_DATA_DIR/venv/bin/pybabel compile -d $OPENSHIFT_REPO_DIR/wsgi/quiz/ui/translations -D ui
# Build assets
python $OPENSHIFT_REPO_DIR/manage.py assets build
