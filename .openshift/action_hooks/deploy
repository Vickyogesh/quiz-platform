#!/bin/bash
# This deploy hook gets executed after dependencies are resolved and the
# build hook has been run but before the application has been started back
# up again.  This script gets executed directly, so it could be python, php,
# ruby, etc.

if [ $OPENSHIFT_REPO_DIR/misc/config.ini -nt $OPENSHIFT_DATA_DIR/quiz/config.ini ]; then
echo "Updating config.ini"
cp $OPENSHIFT_REPO_DIR/misc/config.ini $OPENSHIFT_DATA_DIR/quiz/config.ini
fi

if [ $OPENSHIFT_REPO_DIR/misc/uwsgi.ini -nt $OPENSHIFT_DATA_DIR/quiz/uwsgi.ini ]; then
echo "Updating uwsgi.ini"
cp -f $OPENSHIFT_REPO_DIR/misc/uwsgi.ini $OPENSHIFT_DATA_DIR/quiz/uwsgi.ini
fi

if [ $OPENSHIFT_REPO_DIR/misc/nginx.conf -nt $OPENSHIFT_DATA_DIR/quiz/nginx.conf ]; then
echo "Updating nginx.conf"
cp -f $OPENSHIFT_REPO_DIR/misc/nginx.conf $OPENSHIFT_DATA_DIR/quiz/nginx.conf
fi

echo "Pre-processing nginx config..."
env | sed 's/[\%]/\\&/g;s/\([^=]*\)=\(.*\)/s%${\1}%\2%/' > $OPENSHIFT_TMP_DIR/sed.script
cat $OPENSHIFT_REPO_DIR/misc/nginx.conf | sed -f $OPENSHIFT_TMP_DIR/sed.script > $OPENSHIFT_DATA_DIR/nginx/conf/nginx.conf

if [ -d $OPENSHIFT_DATA_DIR/quiz/img ]; then
echo "Unpacking images..."
zip -e $OPENSHIFT_REPO_DIR/misc/img.zip $OPENSHIFT_DATA_DIR/quiz/img
fi
