<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Quiz Platform</title>

<link rel="stylesheet" type="text/css" href="css/style.css" />
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/cookie.js"></script>
<script type="text/javascript" src="js/app.js"></script>
<script src="js/graph/raphael-min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/graph/g.raphael.js" type="text/javascript"></script>
<script src="js/graph/g.line.js" type="text/javascript" charset="utf-8"></script>
<script src="js/graph/g.pie.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="js/organictabs.jquery.js"></script>
<script type="text/javascript" src="js/date.js"></script>

<!--Please wait-->
<link rel="stylesheet" type="text/css" href="js/please_wait/pleasewait.css">
<script type="text/javascript" src="js/please_wait/pleasewait.js"></script>
<!--Please wait-->

<script>
	var i, sHtml;
	var examData;	
	var bFromExam;
	var parentQuizObj;
	var studentId = -1;
	var urlstat;
	
	$(document).ready(function() {

		window.qsid = sessionStorage.getItem('quizqsid');
		window.name = sessionStorage.getItem('quizname');		
		
		var urltext = document.location.href;
		var idtext;
		if (urltext.indexOf('?') > -1) {
			idtext = urltext.substring((urltext.indexOf('?')+4),urltext.length);
			studentId = parseInt(idtext);
		}
		
		bFromExam = sessionStorage.getItem('quizfromexam');
		
		$("#statarea").hide();
		
		WaitMsg.show();
						
		if (studentId > 0)
			urlstat = url("/v1/student/" + studentId + "/exam");
		else
			urlstat = url("/v1/student/me/exam");
			
		$.getJSON(urlstat, 
			function(data) {
				if (data.status != 200) {
					WaitMsg.hide();
					aux_showJSONError(data);
				}
				else {					
					examData = data;
					data = {};
					data.lang = "it";					
					
					if (studentId > 0)
						urlstat = url("/v1/student/" + studentId);
					else
						urlstat = url("/v1/student/me");
						
					$.getJSON(urlstat, data, function(data) {
						if (data.status != 200) {
							WaitMsg.hide();
							aux_showJSONError(data);
						}
						else {
							WaitMsg.hide();							
							$("#statarea").show();
							
							$("#name").html(data.student.name + ' ' + data.student.surname);					
					
							var examX = [];
							var examY = [];
							var examY1 = [];
							var examY2 = [];
							var nCount = 0;
							
							//
							// graph for week test
							//
							for (i = 0; i < examData.exams.length; i++) {
								
								if (examData.exams[i].status == "passed" || examData.exams[i].status == "failed") {							
									
									// parsing date time and convert to local
									var endDate = Date.parse(examData.exams[i].end + ' UTC');

									if (endDate.addDays(7) < Date.today())
										continue;

									examX.push(nCount);
									examY.push(40 - examData.exams[i].errors);
									examY1.push(36);
									if (nCount == 0)
										examY2.push(0);
									else
										examY2.push(1);
									nCount++;
								}
							}							
							examY2[nCount-1] = 40;
							
							if (nCount == 0)
								examY2.push(0);
							else
								examY2.push(1);							
							
							if (nCount > 0) {
								var r = Raphael("wexamgraph");
								var echart = r.linechart(7, 0, $('#wexamgraph').width()-10, $('#wexamgraph').height()-10, 
														examX, 
														[examY2, examY, examY1], 
														{axis:"0 0 1 1", axisxstep:examX.length - 1, colors:['#fff', '#0000ff', '#13ff7e']});
													
								var xText = echart.axis[0].text.items;  
								for(i in xText){ // Iterate through the array of dom elems, the current dom elem will be i
									var nVal = parseInt(xText[i].attr('text')) + 1;
									xText[i].attr({'text': nVal + ''}); // Set the text of the current elem with the result
								}
							}
							
							//
							// graph for month test
							//
							examX = []; examY = []; examY1 = []; examY2 = []; nCount = 0;
							for (i = 0; i < examData.exams.length; i++) {
								
								if (examData.exams[i].status == "passed" || examData.exams[i].status == "failed") {							
									
									// parsing date time and convert to local
									var endDate = Date.parse(examData.exams[i].end + ' UTC');

									if (endDate.addDays(30) < Date.today())
										continue;

									examX.push(nCount);
									examY.push(40 - examData.exams[i].errors);
									examY1.push(36);
									if (nCount == 0)
										examY2.push(0);
									else
										examY2.push(1);
									nCount++;
								}
							}
							examY2[nCount-1] = 40;
							
							if (nCount > 0) {
								var r = Raphael("mexamgraph");
								var echart = r.linechart(7, 0, $('#mexamgraph').width()-10, $('#mexamgraph').height()-10, 
														examX, 
														[examY2, examY, examY1], 
														{axis:"0 0 1 1", axisxstep:examX.length - 1, colors:['#fff', '#0000ff', '#13ff7e']});
													
								var xText = echart.axis[0].text.items;  
								for(i in xText){ // Iterate through the array of dom elems, the current dom elem will be i
									var nVal = parseInt(xText[i].attr('text')) + 1;
									xText[i].attr({'text': nVal + ''}); // Set the text of the current elem with the result
								}
							}
							
							//
							// graph for all test
							//
							examX = []; examY = []; examY1 = []; examY2 = []; nCount = 0;
							for (i = 0; i < examData.exams.length; i++) {
								
								if (examData.exams[i].status == "passed" || examData.exams[i].status == "failed") {							
									examX.push(nCount);
									examY.push(40 - examData.exams[i].errors);
									examY1.push(36);
									if (nCount == 0)
										examY2.push(0);
									else
										examY2.push(1);
									nCount++;
								}
							}
							examY2[nCount-1] = 40;
							
							if (nCount > 0) {
								var r = Raphael("aexamgraph");
								var echart = r.linechart(7, 0, $('#aexamgraph').width()-10, $('#aexamgraph').height()-10, 
														examX, 
														[examY2, examY, examY1], 
														{axis:"0 0 1 1", axisxstep:examX.length - 1, colors:['#fff', '#0000ff', '#13ff7e']});
													
								var xText = echart.axis[0].text.items;  
								for(i in xText){ // Iterate through the array of dom elems, the current dom elem will be i
									var nVal = parseInt(xText[i].attr('text')) + 1;
									xText[i].attr({'text': nVal + ''}); // Set the text of the current elem with the result
								}
							}
						
							// filling topic statistics : week
							for (i = 0; i < data.topics.length; i++) {
								sHtml = '<li><a id="' + (i+1) + '">';
								sHtml += '<div id="wtgraph' + (i+1) + '" style="width:20px; height:20px; float:right; margin-top:-2px"></div>';
								sHtml += data.topics[i].text;
								sHtml += '</a></li>';
								$("#week #topic ul").append(sHtml);
								
								var id = 'wtgraph' + (i+1);
								var r = Raphael(id);
								var nError = data.topics[i].errors.current;
								if (nError != null && nError > 0)
									r.piechart(10, 10, 10, [100 - nError, nError], {strokewidth:0, colors:['#c20808','#219429']});
							}
							
							// filling topic statistics : month
							for (i = 0; i < data.topics.length; i++) {
								sHtml = '<li><a id="' + (i+1) + '">';
								sHtml += '<div id="mtgraph' + (i+1) + '" style="width:20px; height:20px; float:right; margin-top:-2px"></div>';
								sHtml += data.topics[i].text;
								sHtml += '</a></li>';
								$("#month #topic ul").append(sHtml);
								
								var id = 'mtgraph' + (i+1);
								var r = Raphael(id);
								var nError = data.topics[i].errors.week;
								if (nError != null && nError > 0)
									r.piechart(10, 10, 10, [100 - nError, nError], {strokewidth:0, colors:['#c20808','#219429']});
							}
							
							// filling topic statistics : month
							for (i = 0; i < data.topics.length; i++) {
								sHtml = '<li><a id="' + (i+1) + '">';
								sHtml += '<div id="atgraph' + (i+1) + '" style="width:20px; height:20px; float:right; margin-top:-2px"></div>';
								sHtml += data.topics[i].text;
								sHtml += '</a></li>';
								$("#all #topic ul").append(sHtml);
								
								var id = 'atgraph' + (i+1);
								var r = Raphael(id);
								var nError = data.topics[i].errors.week3;
								if (nError != null && nError > 0)
									r.piechart(10, 10, 10, [100 - nError, nError], {strokewidth:0, colors:['#c20808','#219429']});
							}
							
							//
							// topic click events
							//
							$('#topic ul li a').click(function(){
								parentQuizObj = $(this).parent().parent().parent().parent();
								// showing topic errors								
								$('#statarea').css('width', '520px');
								
								var sHtml;
								
								$("#topicerrorlist").empty();
								
								sHtml = '<li>';
								sHtml += '<a id="back" style="cursor:pointer">';
								sHtml += '&nbsp;&nbsp;&nbsp;&nbsp;<-&nbsp;Back</a>';
								sHtml += '</li>';
								$("#topicerrorlist").append(sHtml);

								sHtml = '<li>';
								sHtml += '<a id="' + $(this).attr('id') + '" style="cursor:pointer">';
								sHtml += 'Question List Topic ' + $(this).attr('id') + '</a>';
								sHtml += '<ul>'
								sHtml += '</ul>';
								sHtml += '</li>';
								
								$("#topicerrorlist").append(sHtml);
								
								// filling lists
								WaitMsg.show();
					
								data = {};
								data.lang = "it";
								
								if (studentId > 0)
									urlstat = url("/v1/student/" + studentId + "/topicerrors/" + $(this).attr('id'));
								else
									urlstat = url("/v1/student/me/topicerrors/" + $(this).attr('id'));
									
								$.getJSON(urlstat, data, function(data) {
									if (data.status != 200) {
										WaitMsg.hide();
										aux_showJSONError(data);
									}
									else {
										WaitMsg.hide();
										parentQuizObj.hide();
										
										$('#topicerrorlist').show();
										$('html, body').animate({ scrollTop: 0 }, 0);
										
										var id;
										for (i = 0; i < data.questions.length; i++) {
											id = data.questions[i].id + '_' + i;
											
											sHtml = '<li><a id="' + id + '">';
								
											var image = "https://quizplatform-editricetoni.rhcloud.com/img/" + data.questions[i].image + ".jpg";
											sHtml += '<div class="img" style="width:30px; height:30px; float:left; margin-right:5px; background-image:';
											sHtml += "url('" + image + "');" + 'background-size:contain; background-position:center; background-repeat: no-repeat;">';
											sHtml += '</div>';
											
											var result;
											sHtml += '<div class="result" style="width:30px; height:30px; float:right; margin-left:5px; font-size:20px; text-align:center">';
											if (data.questions[i].answer == 1)
												result = 'V';
											else
												result = 'F';
												
											sHtml += result;
											sHtml += '</div>';
											
											sHtml += 'Question ' + data.questions[i].id + '<br>';
											sHtml += data.questions[i].text;
											sHtml += '</a></li>';
											
											$("#topicerrorlist ul").append(sHtml);
										}
										
										// resizing images of the items
										var nHeight;
										for (i = 0; i < data.questions.length; i++) {
											id = data.questions[i].id + '_' + i;
											nHeight = $('#' + id).height() + 5;
											$('#' + id + ' .img').css('height', nHeight + 'px');
											$('#' + id + ' .result').css('height', nHeight + 'px');
											$('#' + id + ' .result').css('line-height', nHeight + 'px');
										}
									}
								})
								.error(function(data) {
									aux_showError(data.responseText, data.status);
								});
								
								$('#topicerrorlist #back').click(function(){
									$('#topicerrorlist').hide();
									$('#statarea').css('width', '520px');
//									$('#menu').show();
									parentQuizObj.show();
								});
																
							});
							
							if (bFromExam == 1)
								showExamList(7);
								
							$("#statarea").organicTabs();
							$("#month").hide();
							$("#all").hide();							
						}
					})
					.error(function(data) {
						WaitMsg.hide();
						aux_showError(data.responseText, data.status);
					});				
				}
			})
			.error(function(data) {
				WaitMsg.hide();
				aux_showError(data.responseText, data.status);
			});
			
		$("#wexamgraph").click(function(){			
			parentQuizObj = $(this).parent().parent();
			parentQuizObj.hide();
			
			showExamList(7);		
		});
		
		$("#mexamgraph").click(function(){			
			parentQuizObj = $(this).parent().parent();
			parentQuizObj.hide();
			
			showExamList(30);		
		});
		
		$("#aexamgraph").click(function(){			
			parentQuizObj = $(this).parent().parent();
			parentQuizObj.hide();
			
			showExamList(-1);		
		});
		
		$('#backbut').click(function(){
			var type = sessionStorage.getItem("quizutype");
			if (type == 'school')
				window.location = "School.html";
			else
				window.location = "menu.html";
		});
		
/*		
		$('#btnlogout').click(function(){
			window.qsid = null;
			window.location = "index.html";
		});
*/		

		$('.nav li a').click(function(){
			$('#topicerrorlist').hide();			
			$('#examlist').hide();
		});
	});
	
	function showExamList(period) {
		
		$('#statarea').css('width', '520px');
		$("#examlist").empty();
		
		if ($.trim($("#examlist").html()) == '') {
			sHtml = '<li class="examid">';
			sHtml += '<a id="back" style="cursor:pointer">';
			sHtml += '&nbsp;&nbsp;&nbsp;&nbsp;<-&nbsp;Back</a>';
			sHtml += '</li>';
			$("#examlist").append(sHtml);
			
			var correctNum;
			for (i = 0; i < examData.exams.length; i++) {
				if (examData.exams[i].status == "passed" || examData.exams[i].status == "failed") {
					
					// parsing date time and convert to local
					var endDate = Date.parse(examData.exams[i].end + ' UTC');
					
					if (period > 0) {
						if (endDate.addDays(period) < Date.today())
							continue;
					}
					
					correctNum = 40 - examData.exams[i].errors;
					
					sHtml = '<li class="examid">';
					sHtml += '<a id="' + examData.exams[i].id + '" style="cursor:pointer">';
					sHtml += 'Exam ' + examData.exams[i].id + '&nbsp;(' + correctNum + '/40)' + '&nbsp;&nbsp;&nbsp;&nbsp;' + endDate.toString() + '</a>';
					sHtml += '<ul>';
					sHtml += '</ul>';
					sHtml += '</li>'
					
					$("#examlist").append(sHtml);
				}
			}
		}
		
		$('#examlist').show();
		
		$('#examlist .examid a').click(function(){
			var checkElement = $(this).next();
			
			if ($(this).attr('id') == 'back') {
				$('#examlist').hide();
				$('#statarea').css('width', '520px');
				parentQuizObj.show();
				return;
			}
			
			if (checkElement.children().length == 0) {
				
				WaitMsg.show();
				
				data = {};
				data.lang = "it";
				
				$.getJSON(url("/v1/exam/" + $(this).attr('id')), function(data) {
					if (data.status != 200) {
						WaitMsg.hide();
						aux_showJSONError(data);
					}
					else {
						WaitMsg.hide();
						
						var id;
						for (i = 0; i < data.questions.length; i++) {
							id = data.questions[i].id + '_' + i;
							
							sHtml = '<li><a id="' + id + '">';
							
							var image = "https://quizplatform-editricetoni.rhcloud.com/img/" + data.questions[i].image + ".jpg";
							sHtml += '<div class="img" style="width:30px; height:30px; float:left; margin-right:5px; background-image:';
							sHtml += "url('" + image + "');" + 'background-size:contain; background-position:center; background-repeat: no-repeat;">';
							sHtml += '</div>';
							
							var result, bkcolor;
							if (data.questions[i].is_correct == 1)
								bkcolor = '#468847';
							else
								bkcolor = '#b94a48';

							sHtml += '<div class="quizresult">';
							sHtml += '<div style="text-align:center; background-color:' + bkcolor +';">';
							
							if (data.questions[i].answer == 1)
								result = 'V';
							else
								result = 'F';

							sHtml += result;
							sHtml += '</div></div>';
							
							sHtml += 'Question ' + data.questions[i].id + '<br>';
							sHtml += data.questions[i].text;
							sHtml += '</a></li>';
							
							checkElement.append(sHtml);
						}
						
						// resizing images of the items
						var nHeight;
						for (i = 0; i < data.questions.length; i++) {
							id = data.questions[i].id + '_' + i;
							nHeight = $('#' + id).height() + 5;
							$('#' + id + ' .img').css('height', nHeight + 'px');
							$('#' + id + ' .quizresult').css('height', nHeight + 'px');
						}
					}
				});					
			}
			else {
				if(checkElement.is(':visible')) {
    				checkElement.slideUp('normal');
    			}
				if(!checkElement.is(':visible')) {
					checkElement.slideDown('normal');
				}
			}				
		});
	}
	
</script>
	
</head>

<body>
	<div id="work_area">
		<div id="statarea">
<!--			
        	<div id="logoutarea" style="text-align:right;">
				<a id="btnlogout" href="#" >Log out</a>				
			</div>
-->			
			
			<h1 id="name">Name Surname</h1>

			<div style="width:321px; margin:auto">
	        	<ul class="nav" style="padding:0px">
	                <li class="nav-one"><a href="#week" class="current">Last week</a></li>
	                <li class="nav-two"><a href="#month">Last month</a></li>
	                <li class="nav-three"><a href="#all">All</a></li>
	            </ul>
            </div>
            
        	<div class="list-wrap" style="padding-left:5px; padding-right:5px">
        		<ul id="week" class="parentitem">
        			<li id="exam" style="height:150px">
						<span style="padding:7px; display:block; color:#fff">Exam Statistics</span>
						<div id="wexamgraph" style="width:250px; height:110px; float:right; background-color:#fff; margin-right:120px; cursor:pointer">
						</div>
					</li>
					<li id="topic">
						<span style="padding:7px; display:block; color:#fff">Topic Statistics</span>
						<ul>
						</ul>
					</li>
				</ul>
				
				<ul id="month" class="parentitem">
        			<li id="exam" style="height:150px">
						<span style="padding:7px; display:block; color:#fff">Exam Statistics</span>
						<div id="mexamgraph" style="width:250px; height:110px; float:right; background-color:#fff; margin-right:120px; cursor:pointer">
						</div>
					</li>
					<li id="topic">
						<span style="padding:7px; display:block; color:#fff">Topic Statistics</span>
						<ul>
						</ul>
					</li>
				</ul>
				
				<ul id="all" class="parentitem">
        			<li id="exam" style="height:150px">
						<span style="padding:7px; display:block; color:#fff">Exam Statistics</span>
						<div id="aexamgraph" style="width:250px; height:110px; float:right; background-color:#fff; margin-right:120px; cursor:pointer">
						</div>
					</li>
					<li id="topic">
						<span style="padding:7px; display:block; color:#fff">Topic Statistics</span>
						<ul>
						</ul>
					</li>
				</ul>
				
				<!-- exam list -->
				<ul id="examlist" style="display:none" class="parentitem">
				</ul>
				
				<!-- topic error list -->
				<ul id="topicerrorlist" style="display:none" class="parentitem">
				</ul>
        	</div> <!-- END List Wrap -->
        	
        	<div style="width:100%; height:70px">
				<a class="button" id="backbut" style="margin:15px; padding:10px; font-size:22px; float:left; margin-left:150px">
					Torna al Menu
				</a>
			</div>
         
         </div> <!-- END Organic Tabs (Example One) -->
	</div>
</body>

</html>
