<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Quiz Platform</title>

<link rel="stylesheet" type="text/css" href="css/style_reduced.css" />
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/cookie.js"></script>
<script type="text/javascript" src="js/app.js"></script>
<script type="text/javascript" src="js/switch/jquery.iphone-switch.js"></script>
<script type="text/javascript" src="js/jquery.mousewheel.js"></script>

<!--Please wait-->
<link rel="stylesheet" type="text/css" href="js/please_wait/pleasewait.css">
<script type="text/javascript" src="js/please_wait/pleasewait.js"></script>
<!--Please wait-->

<script>
	var curIndex;
	var quizData = [];
	var id_list = [];
  	var answer_list = [];
  	var bAnswerOn = false;
  	var bTerminated = false;
	
	$(document).ready(function() {
		var i, htmlVal;
	
		window.qsid = sessionStorage.getItem('quizqsid');
				
		$("#reviewarea").hide();
		$("#reviewarea #topic h1").html("Error Review");
		
		curIndex = 0;
		fillupReview();
			
		
		$("#tbutton").click(function(){
			if (alreadyAnswered(curIndex) == false) {
				id_list.push(quizData[curIndex].id);
				answer_list.push(1);
				showNext();
			}
		});		
		$("#fbutton").click(function(){
			if (alreadyAnswered(curIndex) == false) {
				id_list.push(quizData[curIndex].id);
				answer_list.push(0);
				showNext();
			}
		});
		
		$('#iswitch').iphoneSwitch("off", 
			function() {
				bAnswerOn = true;
				setQuizEnv();
			},
			function() {
				bAnswerOn = false;
				setQuizEnv();
			});
		
		$('#endbut').click(function(){
			bTerminated = true;
			
			var i, nError = 0;
			
			for (i = 0; i < quizData.length; i++) {				
				if (answer_list[i] != null) {
					if (parseInt(quizData[i].answer) != answer_list[i]) {
						nError++;
					}
				}
			}
			
			// send answer list
			var data = {
				questions: id_list,
				answers: answer_list
			};
			
			WaitMsg.show();
			
			aux_postJSON(url("/v1/errorreview"), data, function (data) {
				if (data.status != 200) {
					WaitMsg.hide();
					aux_showJSONError(data);
					setQuizEnv();
				}
				else
				{
					WaitMsg.hide();
					setQuizEnv();
					alert('Done! Number of errors: ' + nError);
				}
			});				
		});		
		
		$('#backbut').click(function(){
			window.location = "menu.html";
		});

/*		
		$('#btnlogout').click(function(){
			window.qsid = null;
			window.location = "index.html";
		});
*/		
		
		$('#reviewarea').mousewheel(function(event, delta, deltaX, deltaY) {
			if (deltaY > 0) {
				if (alreadyAnswered(curIndex - 1) == true) {
					curIndex--;
					setQuizEnv();
				}
			}				
			else if (deltaY < 0) {
				if (alreadyAnswered(curIndex) == true) {
					curIndex++;
					setQuizEnv();
				}
			}
			
			if (bTerminated == false) {
				return false;
			}
		});
		
		$('#scrollup').click(function(){
			if (alreadyAnswered(curIndex - 1) == true) {
				curIndex--;
				setQuizEnv();
			}
		});		
		$('#scrollup').mousedown(function(){
			$(this).css('background-image','url("img/scrollUpSel.png")');
		});
		$('#scrollup').mouseup(function(){
			$(this).css('background-image','url("img/scrollUp.png")');
		});		
		
		$('#scrolldown').click(function(){
			if (alreadyAnswered(curIndex) == true) {
				curIndex++;
				setQuizEnv();
			}
		});
		$('#scrolldown').mousedown(function(){
			$(this).css('background-image','url("img/scrollDownSel.png")');
		});
		$('#scrolldown').mouseup(function(){
			$(this).css('background-image','url("img/scrollDown.png")');
		});		
	});
	
	function alreadyAnswered(nIndex) {
		if (nIndex >= 0 && nIndex < id_list.length) {		
			for (i = 0; i < id_list.length; i++) {
				if (quizData[nIndex].id == id_list[i])
					break;
			}
			if (i == id_list.length)
				return false;
			else 
				return true;
		}
		else {
			return false;
		}
	}
	
	function fillupReview() {
		WaitMsg.show();
			
		var lang = "it";
		var uri = url("/v1/errorreview");
		var data = {};
		var i;
		
		if (lang != "it")
			data.lang = lang;
		
		$.getJSON(uri, data, function(data) {
			if (data.status != 200) {
				WaitMsg.hide();
				aux_showJSONError(data);
			}
			else {
				WaitMsg.hide();
				
				$("#reviewarea").show();				
				
				for (i = 0; i < data.questions.length; i++) {
					quizData.push(data.questions[i]);
				}
				
				setQuizEnv();
			}
		});
	}

	function showNext() {		
		if (curIndex < quizData.length) {
			curIndex++;
			setQuizEnv();
		}
		
		if (curIndex == quizData.length - 3) {
			fillupReview();
		}
	}
	
	function setQuizEnv() {	
		
		var quizhtml1, quizhtml2;
		var i, j = 0;
		
		quizhtml1 = '<div class="text" style="background-color:#818183">';
		quizhtml1 += '</div>';
		quizhtml1 += '<div class="answer" style="background-color:#818183;">';
		quizhtml1 += '<img class="topt" src="img/true.png"/>';
		quizhtml1 += '<img class="fopt" src="img/false.png" />';
		quizhtml1 += '</div>';			
		
		quizhtml2 = '<div class="text" style="background-color:#a9a9ab;">';
		quizhtml2 += '</div>';
		quizhtml2 += '<div class="answer" style="background-color:#a9a9ab;">';
		quizhtml2 += '<img class="topt" src="img/true.png"/>';
		quizhtml2 += '<img class="fopt" src="img/false.png" />';
		quizhtml2 += '</div>';			
		
		if (bTerminated == false) {
			// removing		
			if (curIndex == 0) {
				$("#quiz01").empty();
				$("#quiz02").empty();
			}
			else if (curIndex == 1) {
				$("#quiz01").empty();		
				$("#quiz02").empty();
				$("#quiz02").append(quizhtml2);
			}
			else if (curIndex == 2) {
				$("#quiz01").empty();		
				$("#quiz01").append(quizhtml1);
			}			
			
			for (i = curIndex - 2; i < curIndex + 3; i++, j++) {
				var id;
							
				if (i < 0) {
					continue;				
				}
				else if (i >= quizData.length) {
					id = "#quiz0" + (j+1);
					$(id).empty();
					continue;
				}
								
				if (j == 2)
					id = "#quiz0" + (j+1) + " .maintext p";
				else 
					id = "#quiz0" + (j+1) + " .text";
					
				var text = quizData[i].text;
				$(id).html(text);
				
				var image = "https://quizplatform-editricetoni.rhcloud.com/img/" + quizData[i].image + ".jpg";
				$("#imagearea").css("background-image","url('" + image + "')");
				
				id = "#quiz0" + (j+1) + " .answer";
				$(id).removeClass('trueAnswer');
				$(id).removeClass('falseAnswer');
				
				id = "#quiz0" + (j+1) + " .topt";
				$(id).attr('src', 'img/true.png');				

				id = "#quiz0" + (j+1) + " .fopt";
				$(id).attr('src', 'img/false.png');		
				
				if (alreadyAnswered(i) == true) {
					if (answer_list[i] == 1) {
						id = "#quiz0" + (j+1) + " .topt";				
						$(id).attr('src', 'img/true_selected.png');
						id = "#quiz0" + (j+1) + " .fopt";				
						$(id).attr('src', 'img/false.png');			
					}
					else if (answer_list[i] == 0) {
						id = "#quiz0" + (j+1) + " .topt";				
						$(id).attr('src', 'img/true.png');
						id = "#quiz0" + (j+1) + " .fopt";				
						$(id).attr('src', 'img/false_selected.png');
					}
					
					// checking answer is correct
					id = "#quiz0" + (j+1) + " .answer";
					if (bAnswerOn == true) {
						if (parseInt(quizData[i].answer) == answer_list[i]) {
							$(id).addClass('trueAnswer');
						}
						else {
							$(id).addClass('falseAnswer');
						}
					}
				}
			}
			
			var ansHeight = $("#quiz03 .maintext").height();
			var ansTop = (ansHeight - $("#quiz03 .topt").height()) / 2;
			$("#quiz03 .answer").height(ansHeight);
			$("#quiz03 .topt").css('margin-top', ansTop + 'px');
			$("#quiz03 .fopt").css('margin-top', ansTop + 'px');
		}
		else {
			// removing
			$("#scrollbararea").hide();
			$('#quizlistarea').empty();
			$('#quizlistarea').width(560);
			$('#quizlistarea').height(192);
			
			var html;
			
			for (i = 0; i < quizData.length; i++) {
				html = '<div id="quiz0' + (i+1) + '" style="width:578px; height:31px; margin-top:5px">';
				html += quizhtml2;
				html += '</div>';
				
				$('#quizlistarea').append(html);
				$('#quizlistarea').css('overflow-y', 'scroll');
				$('#quizlistarea').css('overflow-x', 'hidden');
								
				id = "#quiz0" + (i+1) + " .text";
				var text = quizData[i].text;
				$(id).html(text);
				
				if (answer_list[i] == 1) {
					id = "#quiz0" + (i+1) + " .topt";				
					$(id).attr('src', 'img/true_selected.png');
					id = "#quiz0" + (i+1) + " .fopt";				
					$(id).attr('src', 'img/false.png');			
				}
				else if (answer_list[i] == 0) {
					id = "#quiz0" + (i+1) + " .topt";				
					$(id).attr('src', 'img/true.png');
					id = "#quiz0" + (i+1) + " .fopt";				
					$(id).attr('src', 'img/false_selected.png');
				}
				
				// checking answer is correct
				id = "#quiz0" + (i+1) + " .answer";
				if (answer_list[i] != null) {
					$(id).removeClass('trueAnswer');
					$(id).removeClass('falseAnswer');
					
					if (parseInt(quizData[i].answer) == answer_list[i]) {
						$(id).addClass('trueAnswer');
					}
					else {
						$(id).addClass('falseAnswer');
					}
				}
			}
		}
		
		// set height of the scroll bar
		var nHeight = $("#quizlistarea").height();
		$("#scrollbararea").css('height', nHeight + 'px');
	}
</script>
	
</head>

<body>
	<div id="work_area">
		<div id="reviewarea" style="width:732px; height:319px; background-color:#6d6c72; position:relative">
			
			<div id="topic" style="width:501px; height: 60px; color:#ffffff; float:left">
				<h1>quiz topic</h1>
			</div>
			
			<div id="switch" style="width:154px; height:60px; float:left">
				<h2 style="margin:5px 0px 0px 0px; color:white">Solutions</h2>
				<div id="iswitch" style="float:left; margin-left:30px;"></div>
			</div>

<!--			
			<div id="logoutarea" style="position:absolute; top:20px; left:670px;">
				<a id="btnlogout" href="#" style="color:#fff">Log out</a>				
			</div>
-->			
			
			<div id="imagearea">
			</div>
			<div id="quizarea" style="width:578px; float:left">
				<div id="quizlistarea" style="width:547px; float:left">
					<!-- 1 -->
					<div id="quiz01" style="height:40px;">
						<div class="text" style="background-color:#818183;">
						</div>
						<div class="answer" background-color:#818183;">
							<img class="topt" src="img/true.png"/>
							<img class="fopt" src="img/false.png" />
						</div>
					</div>
					
					<!-- 2 -->
					<div id="quiz02" style="height:31px;">
						<div class="text" style="background-color:#a9a9ab;">
						</div>
						<div class="answer" style="background-color:#a9a9ab;">
							<img class="topt" src="img/true.png"/>
							<img class="fopt" src="img/false.png" />	
						</div>					
					</div>
					
					<!-- 3 -->
					<div id="quiz03" style="height:31px;">
						<div class="maintext">
							<p></p>
						</div>
						<div class="answer" style="margin:7px 7px; height:38px; line-height:38px; background-color:#ffffff;">
							<img id="tbutton" class="topt" src="img/true.png" style="margin-top:9px"/>
							<img id="fbutton" class="fopt" src="img/false.png" style="margin-top:9px"/>
						</div>	
					</div>
					
					<!-- 4 -->
					<div id="quiz04" style="height:31px;">
						<div class="text" style="background-color:#a9a9ab;">
						</div>
						<div class="answer" style="background-color:#a9a9ab;">
							<img class="topt" src="img/true.png" />
							<img class="fopt" src="img/false.png" />
						</div>						
					</div>
					
					<!-- 5 -->
					<div id="quiz05" style="height:31px;">
						<div class="text" style="background-color:#818183;">
						</div>
						<div class="answer" style="background-color:#818183;">
							<img class="topt" src="img/true.png" />
							<img class="fopt" src="img/false.png" />
						</div>						
					</div>
				</div>
				<div id="scrollbararea" style="width:19px; background-color:#fff; float:left; border-radius: 15px 15px 15px 15px; position:relative">
					<div id="scrollup" style="position:absolute; top:0px; width:19px; height:19px; background-image:url('img/scrollUp.png'); background-size:contain; cursor:pointer">
					</div>
					<div id="scrolldown" style="position:absolute; bottom:0px; width:19px; height:19px; background-image:url('img/scrollDown.png'); background-size:contain; cursor:pointer">
					</div>
				</div>
			</div>
			
			<div style="width:100%; float:left; margin-top:20px; background-color:#142f66; height:70px">
				<a class="button" id="backbut" style="margin:12px; padding:7px; font-size:17px; float:left; margin-left:77px">
					Torna al Menu
				</a>
				<a class="button" id="endbut" style="margin:12px; padding:7px; font-size:17px; float:right; margin-right:77px">
					Correggi
				</a>
			</div>
		</div>
	</div>
</body>

</html>
