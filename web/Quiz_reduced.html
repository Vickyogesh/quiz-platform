<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Quiz Platform</title>

<link rel="stylesheet" type="text/css" href="css/style_reduced.css" />
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/cookie.js"></script>
<script type="text/javascript" src="js/app.js"></script>
<script type="text/javascript" src="js/switch/jquery.iphone-switch.js"></script>
<script type="text/javascript" src="js/jquery.mousewheel.js"></script>

<!--Please wait-->
<link rel="stylesheet" type="text/css" href="js/please_wait/pleasewait.css">
<script type="text/javascript" src="js/please_wait/pleasewait.js"></script>
<!--Please wait-->

<script>
	var curIndex;
	var quizData = [];
	var id_list = [];
  	var answer_list = [];
  	var bAnswerOn = false;
  	var bTerminated = false;
  	var topicIndex;
  	var topic_list = [
  		"Definizioni stradali e di traffico",
		"Definizioni e classificazione dei veicoli",
		"Doveri del conducente ed uso responsabile della strada",
		"Riguardo verso gli utenti deboli della strada",
		"Segnali di pericolo",
		"Segnali di divieto",
		"Segnali di obbligo",
		"Segnali di precedenza",
		"Segnaletica orizzontale",
		"Segnalazioni semaforiche",
		"Segnalazioni degli agenti del traffico",
		"Segnali di indicazione",
		"Segnali complementari",
		"Segnali temporanei e di cantiere",
		"Pannelli integrativi dei segnali",
		"Pericolo e intralcio alla circolazione - Limiti di velocità",
		"Distanza di sicurezza",
		"Norme sulla circolazione dei veicoli",
		"Posizione dei veicoli sulla carreggiata",
		"Cambio di direzione o di corsia (svolta)",
		"Comportamento agli incroci",
		"Norme sulla precedenza",
		"Comportamento in presenza di cortei - Obblighi verso i veicoli di polizia",
		"Esempi di precedenza (ordine di precedenza agli incroci)",
		"Norme sul sorpasso",
		"Fermata, sosta, arresto e partenza",
		"Ingombro della carreggiata",
		"Segnalazione di veicolo fermo",
		"Norme sulla circolazione in autostrada e strade extraurbane principali",
		"Trasporto di persone",
		"Carico dei veicoli - Pannelli sui veicoli",
		"Traino dei veicoli e dei veicoli in avaria",
		"Rischi nella guida",
		"Uso delle luci - Uso dei dispositivi acustici - Spie e simboli",
		"Equipaggiamento - Cinture e sistemi di ritenuta per bambini - Casco",
		"Documenti di circolazione del veicolo",
		"Comportamenti per prevenire incidenti - Comportamento in caso di incidente",
		"Guida in relazione alle condizioni psicofisiche - Alcool, droga e farmaci",
		"Primo soccorso",
		"Responsabilità civile, penale, amministrativa",
		"Assicurazione R.C.A. - Altre forme assicurative legate al veicolo",
		"Limitazione dei consumi - Rispetto dell'ambiente - Inquinamento",
		"Stabilità e tenuta di strada del veicolo",
		"Elementi del veicolo importanti per la sicurezza - Manutenzione ed uso",
		"Comportamenti e cautele di guida"
  	];
  	var chapter_list = [
  		[1, 2, 3, 4],
		[5],
		[6],
		[7],
		[8],
		[9],
		[10, 11],
		[12],
		[13, 14],
		[15],
		[16],
		[17],
		[18, 19, 20, 21, 22, 23],
		[24],
		[25],
		[26],
		[27, 28, 29, 30, 31, 32, 33],
		[34],
		[35],
		[36],
		[37],
		[38, 39],
		[40, 41],
		[42],
		[43, 44, 45]
	];
	
	$(document).ready(function() {
		var i, j, htmlVal;
		
		$("#topicgroup #chapterarea").empty();
		for (i = 0; i < chapter_list.length; i++) {
			htmlVal = '<div id="chapter' + (i+1) + '" class="slider" style="font-size:15px; background-color:#707070; cursor:pointer;">';
			htmlVal += '<p style="padding-left:10px; float:left">';
			htmlVal += '<a>Capitolo ' + (i+1) + '</a>';
			htmlVal += '<div id="expandsign" style="float:right; width:15px; height:15px; margin:7px"></div>';
			htmlVal += '</p></div>';
			htmlVal += '<div id="topiclist' + (i+1) + '" class="slider" style="display:none">';
			for (j = 0; j < chapter_list[i].length; j++) {
				htmlVal += '<p id="' + chapter_list[i][j] + '" class="result"><a href="#">' + chapter_list[i][j] + '. ' + topic_list[chapter_list[i][j]-1] + '</a></p>';
			}			
			htmlVal += '</div>';
			
			$("#topicgroup #chapterarea").append(htmlVal);
		}	

		window.qsid = sessionStorage.getItem('quizqsid');		
		
		$("#quizarea").hide();
		
		$(".result").click(function(){			
			topicIndex = $(this).attr("id");
			curIndex = 0;
			fillupQuiz();			
		});
		
		$("#tbutton").click(function(){
			if (alreadyAnswered(curIndex) == false) {
				id_list.push(quizData[curIndex].id);
				answer_list.push(1);
				showNext();
			}
		});		
		$("#fbutton").click(function(){
			if (alreadyAnswered(curIndex) == false) {
				id_list.push(quizData[curIndex].id);
				answer_list.push(0);
				showNext();
			}
		});
		
		$('#iswitch').iphoneSwitch("off", 
			function() {
				bAnswerOn = true;
				setQuizEnv();
			},
			function() {
				bAnswerOn = false;
				setQuizEnv();
			});
		
		$('#endbut').click(function(){
			bTerminated = true;
			
			var i, nError = 0;
			
			for (i = 0; i < quizData.length; i++) {				
				if (answer_list[i] != null) {
					if (parseInt(quizData[i].answer) != answer_list[i]) {
						nError++;
					}
				}
			}
			
			// send answer list
			var data = {
				questions: id_list,
				answers: answer_list
			};
			
			WaitMsg.show();
			
			aux_postJSON(url("/v1/quiz/" + topicIndex), data, function (data) {
				if (data.status != 200) {
					WaitMsg.hide();
					aux_showJSONError(data);
					setQuizEnv();
				}
				else
				{
					WaitMsg.hide();
					alert('Done! Number of errors: ' + nError);
					setQuizEnv();
				}
			});			
		});		
		
		$('#backbut, #backbut1').click(function(){
			window.location = "student.html";
		});
		
		$('#btnlogout').click(function(){
			window.qsid = null;
			window.location = "index.html";
		});
		
		$('#quizlistarea').mousewheel(function(event, delta, deltaX, deltaY) {
			if (deltaY > 0) {
				if (alreadyAnswered(curIndex - 1) == true) {
					curIndex--;
					setQuizEnv();
				}
			}				
			else if (deltaY < 0) {
				if (alreadyAnswered(curIndex) == true) {
					curIndex++;
					setQuizEnv();
				}
			}
			
			if (bTerminated == false) {
				return false;
			}
		});
		
		$('#scrollup').click(function(){
			if (alreadyAnswered(curIndex - 1) == true) {
				curIndex--;
				setQuizEnv();
			}
		});		
		$('#scrollup').mousedown(function(){
			$(this).css('background-image','url("img/scrollUpSel.png")');
		});
		$('#scrollup').mouseup(function(){
			$(this).css('background-image','url("img/scrollUp.png")');
		});		
		
		$('#scrolldown').click(function(){
			if (alreadyAnswered(curIndex) == true) {
				curIndex++;
				setQuizEnv();
			}
		});
		$('#scrolldown').mousedown(function(){
			$(this).css('background-image','url("img/scrollDownSel.png")');
		});
		$('#scrolldown').mouseup(function(){
			$(this).css('background-image','url("img/scrollDown.png")');
		});		
		
		for (i = 1; i <= 25; i++) {
			var esignid = '#chapter' + i + ' #expandsign';
			$(esignid).addClass('collapse');
		}
		
		$('.slider').click(function(){
			var checkElement = $(this).next();
			var esignid = '#' + $(this).attr('id') + ' #expandsign';
			
			if(checkElement.is(':visible')) {				
				checkElement.slideUp('normal');
				$(esignid).removeClass('expand');
				$(esignid).addClass('collapse');
			}
			if(!checkElement.is(':visible')) {
				checkElement.slideDown('normal');
				$(esignid).removeClass('collapse');
				$(esignid).addClass('expand');
			}
		});
	});
	
	function alreadyAnswered(nIndex) {
		if (nIndex >= 0 && nIndex < id_list.length) {		
			for (i = 0; i < id_list.length; i++) {
				if (quizData[nIndex].id == id_list[i])
					break;
			}
			if (i == id_list.length)
				return false;
			else 
				return true;
		}
		else {
			return false;
		}
	}
	
	function fillupQuiz() {
		WaitMsg.show();
			
		var lang = "it";
		var uri = url("/v1/quiz/" + topicIndex);
		var data = {};
		var i;
		
		if (lang != "it")
			data.lang = lang;
		
		$.getJSON(uri, data, function(data) {
			if (data.status != 200) {
				WaitMsg.hide();
				aux_showJSONError(data);
			}
			else {
				WaitMsg.hide();
				
				$("#topicgroup").hide();
				$("#quizarea").show();
				
				$("#quizarea #topic h1").html(topic_list[data.topic-1]);				

				for (i = 0; i < data.questions.length; i++) {
					quizData.push(data.questions[i]);
				}
				
				setQuizEnv();
			}
		});
	}
	
	function showNext() {
		
		if (curIndex < quizData.length) {
			curIndex++;
			setQuizEnv();
		}
		
		if (curIndex == quizData.length - 3) {
			fillupQuiz();
		}
	}
	
	function setQuizEnv() {	
		
		var quizhtml1, quizhtml2;
		var i, j = 0;
		
		quizhtml1 = '<div class="text" style="background-color:#4c739f">';
		quizhtml1 += '</div>';
		quizhtml1 += '<div class="answer" style="background-color:#4c739f;">';
		quizhtml1 += '<img class="topt" src="img/true.png"/>';
		quizhtml1 += '<img class="fopt" src="img/false.png" />';
		quizhtml1 += '</div>';			
		
		quizhtml2 = '<div class="text" style="background-color:#869fbb;">';
		quizhtml2 += '</div>';
		quizhtml2 += '<div class="answer" style="background-color:#869fbb;">';
		quizhtml2 += '<img class="topt" src="img/true.png"/>';
		quizhtml2 += '<img class="fopt" src="img/false.png" />';
		quizhtml2 += '</div>';			
		
		if (bTerminated == false) {
			// removing		
			if (curIndex == 0) {
				$("#quiz01").empty();
				$("#quiz02").empty();
			}
			else if (curIndex == 1) {
				$("#quiz01").empty();		
				$("#quiz02").empty();
				$("#quiz02").append(quizhtml2);
			}
			else if (curIndex == 2) {
				$("#quiz01").empty();		
				$("#quiz01").append(quizhtml1);
			}			
			
			for (i = curIndex - 2; i < curIndex + 3; i++, j++) {
				var id;
							
				if (i < 0) {
					continue;				
				}
				else if (i >= quizData.length) {
					id = "#quiz0" + (j+1);
					$(id).empty();
					continue;
				}
								
				if (j == 2)
					id = "#quiz0" + (j+1) + " .maintext p";
				else 
					id = "#quiz0" + (j+1) + " .text";
					
				var text = quizData[i].text;
				$(id).html(text);
				
				var image = "https://quizplatform-editricetoni.rhcloud.com/img/" + quizData[i].image + ".jpg";
				$("#imagearea").css("background-image","url('" + image + "')");
				
				id = "#quiz0" + (j+1) + " .answer";
				$(id).removeClass('trueAnswer');
				$(id).removeClass('falseAnswer');
				
				id = "#quiz0" + (j+1) + " .topt";
				$(id).attr('src', 'img/true.png');				

				id = "#quiz0" + (j+1) + " .fopt";
				$(id).attr('src', 'img/false.png');					
				
				if (alreadyAnswered(i) == true) {
					if (answer_list[i] == 1) {
						id = "#quiz0" + (j+1) + " .topt";				
						$(id).attr('src', 'img/true_selected.png');
						id = "#quiz0" + (j+1) + " .fopt";				
						$(id).attr('src', 'img/false.png');			
					}
					else if (answer_list[i] == 0) {
						id = "#quiz0" + (j+1) + " .topt";				
						$(id).attr('src', 'img/true.png');
						id = "#quiz0" + (j+1) + " .fopt";				
						$(id).attr('src', 'img/false_selected.png');
					}
					
					// checking answer is correct
					id = "#quiz0" + (j+1) + " .answer";
					if (bAnswerOn == true) {
						if (parseInt(quizData[i].answer) == answer_list[i]) {
							$(id).addClass('trueAnswer');
						}
						else {
							$(id).addClass('falseAnswer');
						}
					}
				}
			}
			
			var ansHeight = $("#quiz03 .maintext").height();
			var ansTop = (ansHeight - $("#quiz03 .topt").height()) / 2;
			$("#quiz03 .answer").height(ansHeight);
			$("#quiz03 .topt").css('margin-top', ansTop + 'px');
			$("#quiz03 .fopt").css('margin-top', ansTop + 'px');
		}
		else {
			// removing
			$("#scrollbararea").hide();
			$('#quizlistarea').empty();
			$('#quizlistarea').width(560);
			$('#quizlistarea').height(192);
			
			var html;
			
			for (i = 0; i < quizData.length; i++) {
				html = '<div id="quiz0' + (i+1) + '" style="width:578px; height:31px; margin-top:5px">';
				html += quizhtml2;
				html += '</div>';
				
				$('#quizlistarea').append(html);
				$('#quizlistarea').css('overflow-y', 'scroll');
				$('#quizlistarea').css('overflow-x', 'hidden');
								
				id = "#quiz0" + (i+1) + " .text";
				var text = quizData[i].text;
				$(id).html(text);
				
				if (answer_list[i] == 1) {
					id = "#quiz0" + (i+1) + " .topt";				
					$(id).attr('src', 'img/true_selected.png');
					id = "#quiz0" + (i+1) + " .fopt";				
					$(id).attr('src', 'img/false.png');			
				}
				else if (answer_list[i] == 0) {
					id = "#quiz0" + (i+1) + " .topt";				
					$(id).attr('src', 'img/true.png');
					id = "#quiz0" + (i+1) + " .fopt";				
					$(id).attr('src', 'img/false_selected.png');
				}
				
				// checking answer is correct
				id = "#quiz0" + (i+1) + " .answer";
				if (answer_list[i] != null) {
					$(id).removeClass('trueAnswer');
					$(id).removeClass('falseAnswer');
					
					if (parseInt(quizData[i].answer) == answer_list[i]) {
						$(id).addClass('trueAnswer');
					}
					else {
						$(id).addClass('falseAnswer');
					}
				}
			}
		}
		
		// set height of the scroll bar
		var nHeight = $("#quizlistarea").height();
		$("#scrollbararea").css('height', nHeight + 'px');
	}
</script>
	
</head>

<body>
	<div id="work_area">
		<div id="topicgroup" style="width:732px; margin:auto;">
			<div id="chapterarea" style="width:100%; background-color:#315f91; padding:30px 0px">
			</div>
			<div style="width:100%; height:100px; background-color:#142f66">
				<a class="button" id="backbut1" style="width:200px; height:30px; font-size:20px; line-height:30px; margin-top:20px">Go to Main Menu</a>
			</div>
		</div>	
		
		<div id="quizarea" style="width:732px; height:349px; background-color:#315f91; position:relative">
			
			<div id="topic" style="width:501px; height: 90px; color:#ffffff; float:left">
				<h1 style="margin:20px">quiz topic</h1>
			</div>
			
			<div id="switch" style="width:154px; height:90px; float:left">
				<h2 style="margin:10px 0px 0px 0px; color:white">Soluzioni</h2>
				<div id="iswitch" style="float:left; margin-left:30px"></div>
			</div>
<!--			
			<div id="logoutarea" style="position:absolute; top:20px; left:670px;">
				<a id="btnlogout" href="#" style="color:#fff">Log out</a>				
			</div>
-->			
			
			<div id="imagearea">
			</div>
			<div id="quizarea" style="width:578px; float:left">
				<div id="quizlistarea" style="width:547px; float:left">
					<!-- 1 -->
					<div id="quiz01" style="height:31px;">
						<div class="text" style="background-color:#4c739f;">
						</div>
						<div class="answer" background-color:#4c739f;">
							<img class="topt" src="img/true.png"/>
							<img class="fopt" src="img/false.png" />
						</div>
					</div>
					
					<!-- 2 -->
					<div id="quiz02" style="height:31px;">
						<div class="text" style="background-color:#869fbb;">
						</div>
						<div class="answer" style="background-color:#869fbb;">
							<img class="topt" src="img/true.png"/>
							<img class="fopt" src="img/false.png" />	
						</div>					
					</div>
					
					<!-- 3 -->
					<div id="quiz03" style="height:46px;">
						<div class="maintext">
							<p></p>
						</div>
						<div class="answer" style="margin:7px 7px; height:38px; line-height:38px; background-color:#ffffff;">
							<img id="tbutton" class="topt" src="img/true.png" style="margin-top:9px"/>
							<img id="fbutton" class="fopt" src="img/false.png" style="margin-top:9px"/>
						</div>	
					</div>
					
					<!-- 4 -->
					<div id="quiz04" style="height:31px;">
						<div class="text" style="background-color:#869fbb;">
						</div>
						<div class="answer" style="background-color:#869fbb;">
							<img class="topt" src="img/true.png" />
							<img class="fopt" src="img/false.png" />
						</div>						
					</div>
					
					<!-- 5 -->
					<div id="quiz05" style="height:31px;">
						<div class="text" style="background-color:#4c739f;">
						</div>
						<div class="answer" style="background-color:#4c739f;">
							<img class="topt" src="img/true.png" />
							<img class="fopt" src="img/false.png" />
						</div>						
					</div>
				</div>			
				<div id="scrollbararea" style="width:19px; background-color:#fff; float:left; border-radius: 10px 10px 10px 10px; position:relative">
					<div id="scrollup" style="position:absolute; top:0px; width:19px; height:19px; background-image:url('img/scrollUp.png'); background-size:contain; cursor:pointer">
					</div>
					<div id="scrolldown" style="position:absolute; bottom:0px; width:19px; height:19px; background-image:url('img/scrollDown.png'); background-size:contain; cursor:pointer">
					</div>
				</div>				
			</div>
			
			<div style="width:100%; float:left; margin-top:20px; background-color:#142f66; height:70px">
				<a class="button" id="backbut" style="margin:12px; padding:7px; font-size:17px; float:left; margin-left:77px">
					Torna al Menu
				</a>
				<a class="button" id="endbut" style="margin:12px; padding:7px; font-size:17px; float:right; margin-right:77px">
					Correggi
				</a>
			</div>
		</div>
	</div>
</body>

</html>
